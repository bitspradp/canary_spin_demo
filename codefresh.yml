version: '1.0'
steps:
  buildTheImage:
    type: build
    description: Builds my service
    image_name: otomato/ornithology
    tag: ${{CF_SHORT_REVISION}}
  pushTheImage:
    type: push
    candidate: ${{buildTheImage}}
    tag: ${{CF_SHORT_REVISION}}
  deployToK8s:
    title: deploy-to-k8s
    image: codefresh/k8s-kubectl
    commands:
      - sed -i -- "s/BUILD_NUMBER/${{CF_SHORT_REVISION}}/g" orni-dep-canary.yml
      - kubectl config use-context cf-staging@codefresh-staging
      - kubectl apply -f orni-dep-canary.yml -n otom8
  testCanary:
    title: testCanary
    image: codefresh/k8s-kubectl
    commands:
      - kubectl config use-context cf-staging@codefresh-staging
      - kubectl run e2e --image=otomato/ornithology:tests --attach=true --restart=Never --rm=true -n=otom8 --  "/tests/it/canarytest.sh"
  triggerProdDeployment:
    image: radial/busyboxplus:curl
    commands:
      - ./deployprod.sh
